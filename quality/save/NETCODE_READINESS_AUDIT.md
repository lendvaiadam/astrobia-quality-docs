# Netcode Readiness Audit

**Date:** 2026-01-15
**Scope:** Core Game Loop & State Management
**Verdict:** **NOT READY** (Requires Architecture Injection)

## 1. Authority Distribution Scan
The codebase currently follows a **Client-Authoritative** model (Monolithic Single Player). Logic is mixed with presentation.

| Component | Current Authority | Risk Level | Notes |
| :--- | :--- | :--- | :--- |
| **Game.js** | GOD CLASS | ðŸ”´ CRITICAL | Manages initialization, loop, input, rendering, and scene graph. |
| **Unit.js** | HYBRID | ðŸ”´ CRITICAL | Contains physics movements, rendering logic (Three.js), and state (position, speed). |
| **SimCore** | PARTIAL | ðŸŸ¡ MEDIUM | Exists as skeleton (`runtime/Store.js`), but major logic is still outside it. |
| **Input.js** | DIRECT | ðŸ”´ CRITICAL | Directly mutates state without serialization (Event-driven but local). |

## 2. Determinism Gaps (Non-Negotiable Fixes)

### A. Time Delta (`dt`)
*   **Current:** `requestAnimationFrame(animate)` -> `clock.getDelta()`
*   **Problem:** Frame rate dependency. Physics integration varies by client FPS.
*   **Fix:** **Fixed Timestep Loop** (Accumulator pattern). Render frame interpolates between fixed ticks.

### B. Randomness (`Math.random`)
*   **Found:** `Math.random()` used in:
    *   `Map vs Timeline` logic
    *   `Unit.js` initialization (stats, starting position)
    *   `RockSystem.js` generation
*   **Fix:** **Seeded PRNG** (e.g., Mulberry32 or similar) inside `SimCore`.

### C. Time Sources (`Date.now` / `performance.now`)
*   **Found:**
    *   `Game.js` IDs: `Date.now().toString(36) + Math.random()....` (Non-deterministic IDs).
    *   `Unit.js`: `this.lastFrameTime = performance.now()` (Logic depends on wall-clock).
*   **Fix:**
    *   Use `SimCore.timeSource.gameTime` (Tick count).
    *   IDs must be deterministic (Sequence-based or Seeded hash).

## 3. State Interface Analysis
*   **Export/Import:** **MISSING**. No easy way to snapshot `Game.js` state.
*   **IDs:** Transient. `cmd_` IDs are generated using `Date.now()`. Replay is impossible.

## 4. Input Command Schema (Missing)
Current interactions call methods directly (e.g., `unit.setTarget()`).
**Required Schema:**
```json
{
  "tick": 1054,
  "unitId": "U-1",
  "type": "MOVE_ORDER",
  "payload": { "x": 10, "y": 20 }
}
```

## 5. Transport Interface (Proposal)
Create `ITransport` stub now to enforce decoupled messaging.
```javascript
interface ITransport {
  send(command: Command);
  onReceive(callback: (cmd: Command) => void);
}
```

---
*Generated by Antigravity Quality Engineer*
